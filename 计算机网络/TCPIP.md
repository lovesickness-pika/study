网络架构

- 传输层的作用：指定接收数据的应用，并交付报文



- 地址对应：
  - MAC地址----数据链路层
  - IP地址----网络层
  - 端口----传输控制层





- TCP/IP或UDP/IP通信中用5个信息识别一个通信：**源ip地址，源端口号，目标ip地址，目标端口号，协议号**（tcp的协议号为6）

### IP

- IP在网络层，网络层的主要作用是：实现终端节点之间的通行
- 互联网中，将所有配有IP地址的设备叫**主机**
- IP地址用于**识别主机**，在TCP/IP通行中，所有主机都有**IP**
- **IP面向无连接**

#### 路由

- 路由控制：保证分组数据最终发送到最终目标地址

#### IP地址

- IPv4地址由32位整数组成



### TCP

- TCP是面向连接的、可靠的流协议
- TCP是端对端传输协议，且在通行前需要建立连接（分别开辟空间资源、端口资源等）
- TCP通过校验和、序列号、确认应答、重发机制、连接管理以及窗口控制等机制实现可靠性传输



#### TCP首部

![img](https://img-blog.csdn.net/20180324192146298?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyOTk4MTUz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)





##### 源端口与目标端口----16位

- 源端口号和目标端口号是识别通信唯一的必要条件

##### 序列号（Seq Sequence Number）----32位

- 使用序列号保证传送数据包的顺序，用于识别是否已经接收数据，判断该数据是否需要接收
- 由于TCP具有重发机制，以客户端发送数据为例，当客户端发送了一个TCP报文后还未收到ACK包，会认为服务端未收到该报文，于是重传，这时服务端可能会收到两个一样的报文，需要通过序列号进行丢弃
- 序列号

##### 确认号（Ack， Acknowledgement Number）----32位

- ack为下一次请求的数据报的序号，正常情况下应该为Seq+数据长度

##### 数据偏移----4位

- tcp报文首部的长度（tcp首部的长度是不确定的，所以需要用一个int类型存储，单位为字节）

**保留**----4位

##### 状态码（重要）----6位

-  紧急URG（Urgent）        当URG=1时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快发送（相当于高优先级的数据），而不要按原来的排队顺序来传送。这时要与首部中紧急指针（Urgent Pointer）字段配合使用。
- 确认ACK（Acknowledgment）      仅当ACK = 1时确认号字段才有效，当ACK = 0时确认号无效。TCP规定，在连接建立后所有的传送的报文段都必须把ACK置为1。
-  推送 PSH（Push）    当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立即就能收到对方的响应。在这种情况下，TCP就可以使用推送（push）操作。这时，发送方TCP把PSH置为1，并立即创建一个报文段发送出去。接收方TCP收到PSH=1的报文段，就尽快地（即“推送”向前）交付接收应用进程。而不用再等到整个缓存都填满了后再向上交付。
- 复位RST（Reset）       当RST=1时，表名TCP连接中出现了严重错误（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立传输连接。RST置为1还用来拒绝一个非法的报文段或拒绝打开一个连接。
- 同步SYN（Synchronization）       在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使SYN=1和ACK=1，因此SYN置为1就表示这是一个连接请求或连接接受报文。
- 终止FIN（Finish）          用来释放一个连接。当FIN=1时，表明此报文段的发送发的数据已发送完毕，并要求释放运输连接。

##### 窗口----16位

- 该字段主要用于TCP滑动窗口进行流量控制，指定接收方允许对方连续发送的数据量（单位为字节）

##### 检验和----16位

- 目的是为了发现TCP首部和数据在发送端到接收端之间发生的任何改动。如果接收方检测到检验和有差错，则TCP段会被直接丢弃。

##### 紧急指针----16位

- 当URG位为1时，TCP头部节点的紧急指针位会记录一个偏移量，指向紧急数据的最后一位（也可以是紧急数据的下一位，两者都是标准），在读取到紧急指针所指向的位置之前，TCP的接受进程都处于紧急状态，当读取到紧急数据后一位时，回复到正常状态。

##### 填充

- 保证报文首部为4byte的整数倍

#### TCP连接





![三次握手.png](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMTkvMTAvMDIvMWNUWVZNdkh0TGkyb0VJLnBuZw?x-oss-process=image/format,png)





![image.png](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMTkvMTAvMDYvdmxzRDNuUlFFZFVoSXdpLnBuZw?x-oss-process=image/format,png)

##### 连接队列

###### 半连接队列

- 服务器第一次收到客户端的 SYN 之后，就会处于 SYN_RCVD 状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，我们把这种队列称之为半连接队列（SYN队列）。
- 服务器发送完SYN-ACK包，如果未收到客户确认包，服务器在一定时间后重传，如果重传次数超过系统规定的最大重传次数，系统将该连接信息从半连接队列中删除。

###### 全连接队列

- 已经完成三次握手的连接，会被内核从半连接队列中取出，然后存放在全连接队列（Accept队列）中，等待进程调用accept函数取出

当然还有一个全连接队列，就是已经完成三次握手，建立起连接的就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。

这里在补充一点关于SYN-ACK 重传次数的问题：



- 半连接队列和全连接队列都有长度限制，当队列满时，系统会丢掉后续的TCP连接（不可以随意丢掉队列中的连接）

- tcp_abort_on_overflow 共有两个值分别是 0 和 1，其分别表示：

  0 ：如果全连接队列满了，那么 server 扔掉 client 发过来的 ack ；
  1 ：如果全连接队列满了，server 发送一个 reset 包给 client，表示废掉这个握手过程和这个连接；



##### 为什么要进行三次握手

- **保证服务端与客户端都能接收到对方的请求**

  1. 客户端向服务端发送SYN包请求连接
  2. 服务端向客户端发送SYN+ACK包，表示能接收到客户端的报文，但需要确认客户端能否接收到服务端的报文
  3. 客户端向服务端发送ACK包，表示能收到服务端的报文

  经过三次握手后，服务端与客户端都能确认对方可以接收到自己发送出去的报文，所以开始分配资源（服务端的资源会在第二次握手就分配）

  


##### 为什么要进行四次分手

- **保证对方已经知道分手请求并已交付完所有需要发送的数据**
  1. 客户端向服务端发送FIN包请求断开连接
  2. 服务端向客户端发送ACK包表示已经收到断开连接请求，但可能有事务未处理完（部分包还没收到确认请求，可能需要重发），客户端需要等待
  3. 服务端所有需要交付的包都已交付完毕，服务端向客户端发送FIN请求
  4. 客户端回应ACK包，表示接受到了关闭连接请求



##### 三次握手可以携带数据嘛

- 第一二次握手不可以携带数据，第三次握手可以



#### 窗口控制

- 使发送端不必等待上一个数据包的确认应答（ack）而直接发送下一个数据包
- tcp首部字段的窗口大小指定了无需等待确认应答就可以连续发送的数据的最大值：发送端在连续发送了*窗口大小*指定的数据报后，就不能再接着发数据，而是要等待ack包，根据ack包中的*窗口大小*决定是否继续发送数据报
- 窗口控制使用了大量的缓冲区：发送端所有还未受到ack的数据包都不能清除，可能要进行重传
- 使用了窗口控制后，发送端接收到之前数据报的ack包后也不会按照确认应答号指定的数据包发送
- 使用快速重传



#### 拥塞控制

四个算法：

##### 慢启动

##### 拥塞避免

##### 拥塞发生

##### 快速恢复



#### 重发机制

- tcp的重发控制有两种：基于时间与基于确认应答号

##### 超时重新发送

- 客户端在发送tcp数据报在一段时间后还没收到对应的ack包，会重新发送该数据报。
- **重发超时**指的是发送端进行数据重发前等待的时间；为了找到一个最短的超时重传时间，在每次收发包都会计算往返时间和偏差，重发超时的时间稍大与往返时间与偏差的总和
- 在BSD的unix和windows中，重发超时的时间都为0.5的整数倍，由于不知道最初数据包的往返时间，一般设置为6s；且再次超时重传时会以两倍的增长，并在一定次数后强制关闭连接；

##### 快速重传

- 快速重传建立在滑动窗口的基础上，当接收端发现自己接收到的数据包漏了某一段，例如接收端已接收到0~1000（序列号为0）字段，后面接收到了2001~3000（序列号为2001）的数据包，那么接收端会在序列号为2001的ack包中将确认号填1001（表示我需要这一段的数据包），当发送端连续收到3次（除了正常的那次）同一确认号的ack包后，会重发该包
- ![这里写图片描述](https://img-blog.csdn.net/20180710115206319?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3doZ3RoZW9uZQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
- 为什么是3次冗余ACK？
  - 未丢包乱序，连续发送三次

##### SACK机制----对快速重传的改善

##### 什么是SYN攻击

- 短时间内利用大量的虚拟ip向服务端发送连接请求，导致server一直重发确认包，同时半连接队列被大量占用，导致正常连接被丢弃



### 其它的一些通信协议



#### DNS

- DNS：维护主机名（域名）与IP地址的映射

- 由于IP地址不适合人类的记忆方式，DNS出现



#### ARP（用IP地址定位MAC地址）

- ARP是一种解决地址问题的协议，以目标IP地址为线索（IP地址分层次），用来定位下一个应该接收数据分包的网络设备对应的MAC地址



#### RARP（用MAC地址定位IP地址）