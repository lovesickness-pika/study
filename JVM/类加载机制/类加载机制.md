##  类加载机制

##### 概述

- Java虚拟机将描述类的数据从Class文件加载到内存，并对数据进行校验、转换分析和初始化，最终形成可被虚拟机直接使用的java类型的过程。



### 类加载的过程

- 一个类型的生命周期为：**加载->验证->准备->解析->初始化->使用->卸载**;其中验证，准备，解析统称为连接。
- 加载，验证，准备，初始化四个步骤的**开始顺序**是确定的，而解析可能发生在初始化之后，这是为了支持java语言的运行时绑定的特性

#### 初始化

《JAVA虚拟机规范》对于类的初始化有严格规定，有且仅有这六种情况会进行类的初始化（已初始化的类型就不用再初始化）：

1. 遇到new、getstatic、putstatic、invokestatic这四条字节码指令时，具体场景有：
   1. 使用new关键字
   2. 读取或设置一个类型的静态字段，这里有个例外是被final修饰，在编译期就已经将结果放入常量池的静态字段不会导致类的初始化
   3. 调用一个类的静态方法的时候
2. 使用java.lang.reflect包的方法对类型进行反射调用的时候
3. 初始化类时，若其父类未发生初始化，会先进行父类的初始化
4. 程序入口的类，即包含main方法的类会被先初始化
5. 使用JDK7新加入的动态语言支持时，如果一个java.lang.invoke.
6. 一个接口有默认方法，这个接口的实现类初始化的时候，该接口要先初始化



#### 加载

##### 加载阶段 完成的事情：

1. 通过类的全限定名来获取定义此类的二进制字节流
2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构
3. 在内存中生成一个代表这个类的java.lang.Class对象,作为方法区对这个类的各种数据的访问入口



#### 验证

- 为什么要有验证阶段？虽然Java语言安全，但字节码不一定是安全的；或者说java语言生成的字节码文件安全，但加载到虚拟机的字节码文件可能是经过恶意篡改的

##### 文件格式验证

- 验证字节流是否符合class文件格式的规范

##### 元数据验证

- 对字节码描述的信息进行语义分析，保证其符合规范

##### 字节码验证

- 通过数据流分析和控制流分析，确定程序语义是合法的、符合逻辑的

##### 符号引用验证

- 发生在虚拟机将符号引用转化为直接引用的时候，对类自身以外（常量池的各类引用）的各类信息进行匹配性校验，通俗来说就检查依赖

#### 准备

- 准备阶段是正式为类的静态成员分配内存并设置类变量初始值的阶段，这个初始值是值类型的默认值，但如果该成员用final修饰后为常量，那么就会直接设置为该值

#### 解析

- 解析阶段是java虚拟机将常量池内的符号引用替换为直接引用的过程

##### 符号引用与直接引用

- 符号引用指能够无歧义的定位到目标的一组符号，可以是任意形式的字面量，虚拟机在将java文件编译为字节码文件的时候，是不知道这个class文件在加载到系统后具体位置，符号引用的定义写在了java虚拟机规范中，所以不同java虚拟机实现的内存布局可能不同，但是它们可以接受的符号引用是一样的
- 当程序运行到类加载的解析阶段的时候，就会根据具体的内存布局将符号引用转化为直接引用；直接引用就是指针、偏移量或者句柄这些，可以通过直接引用来定位到目标在内存中的具体位置；例如，指向实例变量的直接引用就是偏移量