### RDB

- RDB存储的是二进制文件，就类似于innodb的redo log



#### 执行RDB文件的创建与载入

##### 创建

- 有两个指令可以用于生成RDB文件：SAVE和BGSAVE
- SAVE指令会阻塞redis服务器进程，直到RDB文件创建完毕，所以一般不会使用这个指令
- BGSAVE指令会创建一个子线程去进行RDB文件的创建，此时服务器进程仍可以继续处理命令请求

##### 设置间隔保存

- 可以在redis的配置文件中配置，使redis在满足一定条件时自动执行BGSAVE，并且可以同时配置多个条件，当满足其中一个时，就会进行自动保存
- 配置方式，在redis的conf文件中配置 *save 900 1*，指服务器在900秒内，对数据库进行了至少一次修改，或者在启动redis时直接传参

##### 自动间隔保存的实现

- redis使用saveparam数组保存save条件，并使用dirty属性记录写操作的次数，，每条记录的变换都算一次修改操作，同时使用lastsave时间戳来记录距离具体上次save或bgsave的时间
- 然后redis会周期性执行serverCron函数，默认100ms执行一次，这个函数用于对正在运行的函数进行维护，其中一项工作就是检查save选项所设置的保存条件是否已经满足，满足后执行BGSAVE

##### 载入

- redis没有专门用于载入RDB文件的指令，而是在服务器启动时自动执行，并且由于AOF文件的更新频率一般比RDB更高，所以服务区会优先使用AOF文件来还原数据库状态



#### RDB文件的数据结构







### AOF

- AOF是redis提供的逻辑日志
- 被写入AOF文件的所有命令都是以Redis的命令请求协议格式保存的，也就是客户端发送的命令

#### AOF的实现

- AOF的实现有三个步骤：命令追加、文件写入、文件同步；这个过程有点类似于mysql写入redo log的过程

- 命令追加就是每次执行客户端请求时将协议内容追加到aof_buf缓冲区的末尾
- 而文件写入与同步就是每次事件循环结束会执行flushAppendOnlyFile()函数，这个函数根据服务器配置的appendfsync来决定是否要强制将缓存刷新到磁盘



#### AOF文件的载入与数据还原

- AOF文件中包含了重建数据库状态所需的所有写命令，所以服务器只要读入并重新执行一遍AOF里面的写命令就可以还原数据库关闭之前的数据库状态

执行过程：

1. 创建一个不带网络连接的伪客户端，重复的从AOF文件中分析并取出写命令，并执行



#### AOF文件的重写	BGREWRITEAOF

- 随着服务器的运行，AOF文件中的内容会越来越多，可以通过重写的方式创建新的AOF文件来替代现有的AOF文件，其原理就是直接根据数据库现在的状态并使用一条命令去记录键值对

- 在执行BGREWRITEAOF命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建AOF文件期间，记录服务器执行的所有写命令。当子进程完成创建AOF文件的工作之后，服务器会将重写缓冲区的所有内容追加到新AOF文件的末尾，使得新旧两个AOF文件的数据库状态一致。最后，再用新的AOF文件替换旧的AOF文件
