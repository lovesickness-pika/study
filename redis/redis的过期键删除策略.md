### redis的过期键删除策略



#### 三种过期键删除策略



##### 定时删除

- 通过使用定时器，定期删除策略可以保证过期键会尽可能快地被删除，并释放过期键所占用的内存
- 定期删除策略对内存最友好，因为会尽快释放过期键占用的内存；对cpu时间最不友好，在过期键比较多的情况下，删除过期键会占用相当一部分的时间，并且时间事件使用链表存储的，所以查看一个事件的时间复杂度是O(N)，所以无法高效的处理大量的时间事件



##### 惰性删除

- 在取出键时对键进行过期检查
- 惰性删除策略对CPU时间最友好，因为删除的目标仅限于当前处理的键，不会在删除其它无关键上花费任何时间



##### 定期删除

- 定期删除策略每隔一段时间执行一次删除过期键操作，并通过限制删除操作执行时长和频率来减少删除操作对CPU时间的影响



#### redis使用的过期键删除策略

- redis过期键的惰性删除策略由db.c/expireIfNeeded函数实现，定期删除策略由redis.c/activeExpireCycle函数实现

- redis搭配使用惰性删除和定期删除这两种过期键删除策略
  - 所有读写数据库的Redis命令会在执行之前先调用函数expireIfNeeded对输入键进行检查并对过期键进行删除（读命令会先去判断键是否存在）
  - redis的时间事件处理函数redis.c/serverCron执行时，activeExpireCycle函数就会被调用，在规定的时间内，分多次遍历服务器中的各个数据库，从数据库中的expires字典中随机的检查一部分键的过期时间，并删除其中的过期键





#### AOF、RDB和复制过程中对过期键的处理

##### RDB

- 在执行save或bgsave创建新的RDB文件时，程序会对数据库中的键进行检查，已过期的键不会被保存到RDB文件中
- 在启动启动服务器并载入RDB文件时，如果该服务器是主服务器，则程序会对文件中带有过期时间的键进行检查，只载入未过期的键；从服务器会直接载入所有键，但是在主服务器进行同步时会将过期键删除

##### AOF

- 当服务器以AOF持久化模式运行时，如果过期键还未被惰性删除或定期删除，则AOF文件不会受影响，当过期键被删除时，会显式的向aof文件中追加del命令记录删除

##### 复制（集群）

- 复制模式下，为了保证主从服务器数据的一致性，所有服务器的过期删除动作由主服务器控制：
  - 主服务器在删除一个过期键后，会显式地向所有从服务器发送一条del命令
  - 从服务器在执行客户端的读命令时，即使是过期键也不会执行删除，而是正常返回
  - 从服务器只有在接到主服务器的del命令，才会删除过期键