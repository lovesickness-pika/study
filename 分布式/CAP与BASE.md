### CAP定理

- CAP理论告诉我们，一个分布式系统不可能同时满足一致性、可用性和分区容错性，最多同时满足其中两项

#### 一致性（Consistency）

- 在分布式系统中，一致性指数据在多个副本之间能否保持一致性的特性。在一致性的需求下，当一个系统在数据一致的状态下执行更新操作后，应该保证系统的数据仍然处于一致的状态。

#### 可用性（Availability）

- 可用性指系统提供的服务必须一直处于可用的状态，对于每次请求总是能够在有限的时间内返回结果。
  - 有限时间内：不同系统对于这个指标会有不同要求，主要是要在用户的期望值时间内返回
  - 返回结果：指返回成功或失败的结果，而不是让用户困惑的结果

#### 分区容错性（Partition tolerance）

- 分区容错性约定分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障
  - 网络分区：网络分区指在分布式系统中，不同的节点分布在不同的子网络中，由于一些特殊情况导致这些子网络出现网络不连通的情况，但各个子网络的内部网络正常



#### 不同组合的适用场景

- CAP理论指出一致性、可用性、分区容错性三者最多满足两个，不同组合的适用场景如下：

| 放弃的特性          | 说明                                                         |
| ------------------- | ------------------------------------------------------------ |
| 放弃P（分区容错性） | 放弃分区容错性，一种较为简单的做法是将所有的数据（或者仅仅与事务有关的数据）都放在一个分布式节点上，这样可以保证不会遇到由于网络分区带来的负面影响（要不就是完全无法进行事务），但同时系统的可扩展性也被限制了 |
| 放弃A（可用性）     | 与放弃分区容错性不同的是，当系统遇到网络分区故障或者其它故障时，使受影响的服务对外呈不可用状态，等待系统恢复 |
| 放弃C（一致性）     | 放弃一致性指的并非放弃数据的一致性，而是保留数据的最终一致性，承诺系统会在一定时间内最终一致 |



对于大部分的分布式系统而言，各节点应该是分布在不同空间的，那么就一定会出现网络分区，可以说分区容错性是分布式系统的最基本的需求，因此在设计架构时更多的是在可用性和一致性之间找平衡点



### BASE理论

- BASE是指 Basically Available（基本可用）、Soft state（软状态）和Eventually consistency（最终一致性）三个短语的缩写。BASE理论是对CAP定理在大规模互联网系统的实践总结，核心要点是各个应用可以根据自身业务的特点，采用适当的方式使系统达成最终一致性



#### 基本可用

- 基本可用指系统在出现不可预知的故障时，允许牺牲部分可用性。
  - 响应时间的损失：在出现故障时，系统的响应时间变长
  - 功能损失：业务降级

#### 弱状态

- 弱状态指系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同的数据副本之间进行同步的过程中存在延时。

#### 最终一致性

- 最终一致性强调的是经过一段时间后，系统的所有副本达到最终一致的状态

##### 最终一致性应该遵循以下规则

1. 不允许更新丢失，即进程A在更新某个数据后通知的进程B，那么B之后的更新应该是基于这个最新值
2. 进程能够读取到自己最近的更新，对于一个进程来说，它读取到的某个值的版本一定不会比自己上次写入的值更旧
3. 在同一个会话中能够读取到自己最近的更新值
4. 对于已经读取过的值，后续读取不应该返回比这次读取更旧的版本
5. 同一个进程的写操作应该被顺序执行