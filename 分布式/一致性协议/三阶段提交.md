### 3PC Three-phase Commit

- 三阶段提交是在二阶段提交的基础上进行改进，将提交事务过程一分为二，最终形成由Cancommit、PreCommit和doCommit三个阶段



#### 实现过程

##### 阶段一：CanCommit

1. 事务询问，协调者向所有参与者发送带事务内容的canCommit请求，询问是否可以执行事务提交
2. 各参与者收到canCommit请求后，根据自身事务状态返回yes或no

##### 阶段二：PreCommit

- 协调者收到所有参与者的yes响应，执行事务预提交
  1. 协调者向所有参与者发送preCommit请求，进入Prepared阶段
  2. 参与者接收到preCommit请求后，执行事务操作，记录Undo和Redo信息
  3. 参与者返回ack信息，等待最终指令
- 协调者收到某个参与者的no响应，执行事务中断
  1. 协调者向所有参与者发送abort请求
  2. 参与者收到abort请求或者等待超时，中断事务

##### 阶段三：doCommit

- 执行提交
  1. 协调者正常工作，且收到所有参与者的ack响应，从预提交状态转化到提交状态，并向所有参与者发送doCommit请求
  2. 参与者接收到doCommit请求，执行提交操作，释放事务资源
  3. 参与者返回ack
  4. 协调者接收到所有ack信息后，完成事务
- 中断事务
  1. 协调者正常工作，且收到了No反馈或者等待反馈超时，执行中断事务，向所有参与者发送abort请求
  2. 参与者接收到abort请求后，用undo信息执行事务回滚，释放事务资源
  3. 参与者返回ack信息
  4. 协调者接收到所有ack信息后，完成事务中断



#### 三阶段提交与二阶段提交的对比

- 在阶段三的过程中，如果参与者由于各种原因（协调者故障或网络分区问题）未能接收到协调者的doCommit请求或abort请求，则会在等待超时后**继续执行事务提交**。
- 三阶段提交相对于二阶段提交多了一个canCommit阶段，使各参与者根据自身状态判断是否能进行分布式事务，而不是像二阶段提交一样，让所有参与者直接开始事务，之后再根据无法执行事务的参与者的no请求对其它参与者进行回滚，算是一个小优化。其次，三阶段提交给各参与者添加了超时机制，在超时时会执行事务提交并释放事务资源，减小阻塞访问（尤其是协调者故障而带来的阻塞问题），但当无法接受到协调者的abort请求而执行了事务提交的节点会导致数据不一致