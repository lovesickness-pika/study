### 2PC Two-phase Commit

- 大部分的关系型数据库都是使用2PC完成分布式事务的处理，利用该协议可以简单的完成所有分布式事务的提交与回滚，从而能够有效的保证分布式数据的一致性



#### 实现过程

##### 阶段一：提交事务请求

1. 事务询问：协调者向所有参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各事务的响应
2. 执行事务：各参与者节点执行事务，并Undo和Redo信息记入日志
3. 各参与者向协调者反馈事务询问的响应：成功执行返回yes，失败返回false

##### 阶段二：执行事务提交

1. 如果协调者接收到所有参与者的yes反馈，那么执行事务提交：
   1. 协调者向所有参与者发送commit请求
   2. 参与者接收到commit请求后，执行事务提交，完成后释放事务资源
   3. 参与者向协调者发送ack
   4. 协调者接收到所有参与者的ack之后，结束事务
2. 如果协调者接收到某个参与者的no反馈或者有参与者返回超时，执行事务中断
   1. 协调者向所有参与者发送rallback请求
   2. 参与者接收到rallback请求后，利用undo信息执行回滚，完成后释放事务资源
   3. 参与者向协调者发送ack
   4. 协调者收到所有ack之后，完成事务中断

#### 二阶段提交的优势与劣势

优势：原理简单、实现方便

劣势：同步阻塞、单点问题、脑裂、过于保守

1. 同步阻塞：所有参与者要等待协调者的同步指令，参与者越多，同步阻塞带来的性能问题越严重
2. 单点问题：所有参与者由协调者进行调控，当协调者本身出现故障时，分布式事务将会崩溃，尤其在第二阶段中协调者崩溃可能导致所有参与者无法释放事务资源或者严重的数据不一致问题
3. 过于保守：当某个参与者出现故障时，协调者只能依靠本身的超时机制判断是否中断事务，没有较好的容错机制